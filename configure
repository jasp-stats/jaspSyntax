# To manually specify a location for JASP_BUILD_DIR or JASP_SOURCE_DIR do
#
# options(configure.vars = c(jaspSyntax = "JASP_SOURCE_DIR='<path>'"))
# install.packages("jaspSyntax", ...)

set -e


function loadFile() {
	DOWNLOAD_SUCCESS=1
	if curl --version 2>&1 >/dev/null; then
		echo "Downloading $1/$2 with curl"
		curl --silent --output "src/$2" "$1/$2"
		DOWNLOAD_SUCCESS=$?
	fi

	if [ "${DOWNLOAD_SUCCESS}" -ne "0" ]; then
		echo "seeing if wget is available"
		if wget --version 2>&1 >/dev/null; then
			wget --quiet -O  "src/$2" "$1/$2"
			DOWNLOAD_SUCCESS=$?
		fi
	fi
	if [ "${DOWNLOAD_SUCCESS}" -ne "0" ]; then
		printf "Installing jaspSyntax failed because the required file $2 is missing.\n\
Normally this is downloaded automatically if either curl or wget is available, but apparently this failed.\n\
Either download from \"https://github.com/jasp-stats/jasp-desktop/\" manually and specify the path through configure.args: options(configure.vars = c(jaspSyntax = \"JASP_SOURCE_DIR='<path>'\"))"
		exit 1
	fi
}

if [ "${R_HOME}" ]; then
	echo "Found R_HOME: ${R_HOME}"
else
	echo "No R_HOME found!"
fi

PKG_CXXFLAGS=""

if [[ "${JASP_SOURCE_DIR}" ]]; then
	echo "JASP_SOURCE_DIR: ${JASP_SOURCE_DIR}"
	PKG_CXXFLAGS="-I\"${JASP_SOURCE_DIR}/SyntaxInterface\""
elif [ ! -f "src/syntaxbridge_interface.h" ]; then
	if [ "${GITHUB_JASP_DESKTOP_FILES}" = "" ]; then
		GITHUB_JASP_DESKTOP_FILES="https://raw.githubusercontent.com/jasp-stats/jasp-desktop/refs/heads/development"
	fi

	loadFile "${GITHUB_JASP_DESKTOP_FILES}/SyntaxInterface" "syntaxbridge_interface.h"
fi


DLL_NAME="libSyntaxInterface.dylib"

if [[ "${JASP_BUILD_DIR}" ]]; then
	echo "JASP_BUILD_DIR: ${JASP_BUILD_DIR}"
	cp "${JASP_BUILD_DIR}/SyntaxInterface/$DLL_NAME" src/$DLL_NAME
elif [ ! -f "src/${DLL_NAME}" ]; then
	if [ "${JASP_FILE_SERVER}" = "" ]; then
		JASP_FILE_SERVER="https://static.jasp-stats.org/jaspSyntax/1.0/"
	fi

	loadFile "${JASP_FILE_SERVER}" "${DLL_NAME}"
	if [[ ! $(shasum -a 256 src/${DLL_NAME}) =~ "f65285c4fb4d51ee485273cd0202405f5e9043a2dfd893108a6e0dd0df990cca" ]]; then
		echo "Wrong checksum!"
		rm src/${DLL_NAME}
		exit 1
	fi
fi


mkdir -p inst/libs
cp src/"$DLL_NAME" inst/libs/$DLL_NAME

PKG_LIBS=-lSyntaxInterface

sed -e "s|@cppflags@|${PKG_CXXFLAGS}|" -e "s|@libflags@|${PKG_LIBS}|" src/Makevars.in > src/Makevars


exit 0
