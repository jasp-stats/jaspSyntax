# To manually specify a location for QT_BUILD_DIR, JASP_BUILD_DIR or JASP_SOURCE_DIR do
#
# options(configure.vars = c(jaspSyntax = "QT_BUILD_DIR='<path>'"))
# install.packages("jaspSyntax", ...)

set -e

if [ "${R_HOME}" ]; then
	echo "Found R_HOME: ${R_HOME}"
else
	echo "No R_HOME found!"
fi

if [ "${QT_BUILD_DIR}" ]; then
	echo "Found QT_BUILD_DIR: ${QT_BUILD_DIR}"
else
	QT_BUILD_DIR=~/Qt/6.10.1/BuildStaticRelease
	echo "Use default QT_BUILD_DIR: ${QT_BUILD_DIR}"
fi

if [[ ! "${JASP_BUILD_DIR}" ]]; then
	JASP_BUILD_DIR=~/JASP/source/build-jasp-desktop-Qt_6_10_1_for_macOS-Debug
fi
echo "JASP_BUILD_DIR: ${JASP_BUILD_DIR}"

if [[ ! "${JASP_SOURCE_DIR}" ]]; then
	JASP_SOURCE_DIR=~/JASP/source/jasp-desktop
fi
echo "JASP_SOURCE_DIR: ${JASP_SOURCE_DIR}"

if [[ ! "${BUILD_TYPE}" ]]; then
	BUILD_TYPE=Debug
fi
echo "BUILD_TYPE: ${BUILD_TYPE}"


BUILD_DIR="src/backend/build"
INSTALL_DIR="src"

mkdir -p "$BUILD_DIR"
mkdir -p "$INSTALL_DIR"

cd "$BUILD_DIR" || {
	echo "Build dir was not made! Check if you have permissions..."
	exit 1
}

cmake -E env R_HOME="${R_HOME}" JASP_SOURCE_DIR="${JASP_SOURCE_DIR}" JASP_BUILD_DIR="${JASP_BUILD_DIR}" cmake ../src -DCMAKE_GENERATOR="Ninja" -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" -DCMAKE_PREFIX_PATH="${QT_BUILD_DIR}" || {
	echo "CMake configuration failed..."
	exit 1
}

cmake --build . || {
	echo "Build failed..."
	exit 1
}

# Copy the binary in src/
DLL_NAME="libjaspSyntaxBackend.dylib"
if [ -f "$DLL_NAME" ]; then
	cp "$DLL_NAME" ../../$DLL_NAME
	cp "$DLL_NAME" ../../../inst/libs/$DLL_NAME
elif [ -f "${BUILD_TYPE}/$DLL_NAME" ]; then
	cp "${BUILD_TYPE}/$DLL_NAME" ../../$DLL_NAME
	cp "${BUILD_TYPE}/$DLL_NAME" ../../../inst/libs/$DLL_NAME
else
	echo "Could not find built $DLL_NAME"
	exit 1
fi

echo "** SUCCESSFULLY BUILT jaspSyntax BACKEND CODE! **"

CPPFLAGS=-I./backend\ -I"${JASP_SOURCE_DIR}"/SyntaxInterface

cd ../../..

sed -e "s|@cppflags@|${CPPFLAGS}|" -e "s|@libflags@|${LINK_LIBRARIES}|" src/Makevars.in > src/Makevars


exit 0
